debuggVar = 0
icon_img = b'AAABAAEAICAAAAEAIACoEAAAFgAAACgAAAAgAAAAQAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///9/////f////4D///+A////gP///4D///9/////f////3////+A////gP///3////+A////f////3////9/////f////4D///+A////gP///4D///+A////gP///4D///+A////gP///4D///9/////gP///3////9/////QP////////////////////////////////////////////////////////////////////////////////////////////////////+goKD/d3d3//Pz8/////////////////////////////////////////////////////9////////////////////////////////////////////////////////////////////////////q6ur/n5+f/+Li4v//////8/Pz/wAAAP8AAAD/zs7O///////z8/P/oaGh/+Tk5P///////////////////////////////3///////////////////////////////////////////////////////////////////////////6urq/8AAAD/UFBQ/+Li4v+0tLT/AAAA/wAAAP+QkJD/3d3d/4+Pj/+7u7v/+vr6//rq4///////////////////////////gP//////////////////////////////////////////////////////////////////////////2NjY/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/vr6+//759v/8rHX//5MA//PPvf////////////////////9////////////////////////////////////////////////////////////y8vL/4eHh///////S0tL/AAAA/wAAAP89PT3/o6Oj/729vf++vr7/sLCw/8DAwP/89/X//Kpy//+TAP//kwD/89HB//r6+v///////////////4D///////////39/f/U1NT/0dHR/9HR0f/R0dH/0dHR/9HR0f+34Mn/tuDK/1VZWP8AAAD/bGxs/woKCv8AAAD/X15e/8bGxv/R0dH/0dHR/9PT0//6+vr//ff1//2rc///kwD//5MA//jDp//5+fn/dnZ2/+vr6///////////gP//////////+fn5/7a2tv+0s7P/tLOz/7Szs/+0s7P/s7Oz/4zQqv+M0Kr/TWhZ/wAAAP8AAAD/AAAA/5CQkP+0s7P/tLOz/7Szs/+0s7P/tLS0//Hs6f/9rHT//5MA//+TAP/5wqT/+fn5/319ff9DQ0P/8fHx//////////+A//////////////////////////////////////////////////////////+f0LP/N3RU/wAAAP9nZ2f//Pz9///////////////////////++ff//Kpz//+TAP//kwD//MKj//r6+v+EhIT/ZWVl//Pz8////////////////4D//////////////////////////////////////////////////////////5/Ss/82b1D/AAAA/8nJyf///////////////////////vn3//yrc///kwD//5MA//3Cof//////7+/v/wAAAP82Njb/////////////////////gP////////////////////////////////////////////////7+/v+np6f/Xm9l/xslH/8AAAD/5eXl//////////////////359//9rHb//5MA//+TAP/8wJ///v7+////////////V1dX/wAAAP97e3v/kpKS//Dw8P////+A////////////////////////////////////////////////5eXl/wAAAP8AAAD/AAAA/wAAAP/29vb////////////++ff//a13//+TAP//kwD/+r6c//7+/v////////////////93d3f/AAAA/wAAAP8AAAD/vr6+/////4D////////////////+/v7/9vb2//b29v/29vb/9vb2//b29v/29vb/qKio/2hoaP9OTk7/t7e3//T09P/29vb/+PPx//6ueP//kwD//5MA//i7mP/9/f3//////////////////////0lJSf8AAAD/h4eH/56env/29vb/////gP///////////////9bW1v/MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz/zMzM/8vLy//Wu6//7KR2//CibP/2m1L//5MA//+TAP/oonX/0NDQ///////////////////////s7Oz/AAAA/z09Pf////////////////////+A////////////////zMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz/h4aG/3l5ef95eXn/uYxz//+TAP//kwD//5MA//+TAP//kwD/7p9m/8nJyf/MzMz//v7+/////////////////56env8AAAD/Y2Nj/+vr6////////////////4D////////////////MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP9MS0v/QkBA/0JAQP/siiD/948T/8B0Lv/uo3L//5MA//+TAP/PsqT/zMzM/8zMzP/+/v7////////////Pz8//AAAA/wAAAP8AAAD/Ly8v/+7u7v//////////gP///////////////8zMzP/MzMz/zMzM/8DAwP9hYGD/Xl1d/0NBQf9CQED/QkBA/+iIIf9lTUH/Pz09/19eXv/oiB3//5MA/96ym//MzMz/zMzM//7+/v/5+fn/uLi4/wEBAf8AAAD/h4eH/xgYGP8kJCT/7u7u//////////9/////////////////zMzM/8zMzP/Nzc3/urm5/0JAQP9CQED/QkBA/0JAQP9CQED/RkRE/0JAQP9FRET/Xkk+/+6LF///kwD/0Lqw/6+vr/+VlZX/np6e/0NDQ/8AAAD/AAAA/7Gxsf//////8fHx//Dw8P///////////////3/////////////////MzMz/mpmZ/0JAQP9CQED/QkBA/0JAQP9CQED/QkBA/0JAQP9CQED/QkBA/2JKPv/qiiX//5MA/9V+Kf9FQ0P/Hh0d/wAAAP8AAAD/AAAA/wAAAP8AAAD/o6Oj////////////////////////////////f////////////////8zMzP+ZmZn/QkBA/0JAQP9CQED/QkBA/0JAQP9CQED/QkBA/0JAQP9CQED/mGE5/8F0Mf+vbDX/SkRC/0RCQv8AAAD/AAAA/56env/q6ur/np6e/wAAAP9XV1f///////////////////////////////9/////////////////zMzM/5mZmf9CQED/QkBA/0JAQP9CQED/QkBA/0JAQP9CQED/QkBA/0JAQP9CQED/QkBA/0JAQP9CQED/SUdH/wAAAP8AAAD/0NDQ///////4+Pj/urq6/9/f3////////////////////////////////3/////////////////MzMz/mZmZ/0JAQP9CQED/QkBA/0JAQP9CQED/QkBA/0JAQP9CQED/QkBA/0JAQP9CQED/QkBA/0JAQP9CQED/TExM/3V1df/29vb/////////////////////////////////////////////////////gP///////////////8zMzP+ZmZn/QkBA/0JAQP9CQED/QkBA/0JAQP9CQED/QkBA/0JAQP9CQED/QkBA/0JAQP9CQED/QkBA/0JAQP+EhIT/zMzM//7+/v////////////////////////////////////////////////////9/////////////////zMzM/5mZmf9CQED/QkA//0I/QP9CQED/QkBA/0JAQP9CQED/QkBA/0JAQP9CQED/QkBA/0I/QP9CQD//QkBA/4SEhP/MzMz//v7+/////////////////////////////////////////////////////4D////////////////MzMz/mZmZ/051iv9oxfL/P0VK/2rE8f9Md47/Ya/W/1SVtv9Ylrb/YbPc/012if9oxfL/QlBZ/2rG8f9Ne5X/hISE/8zMzP/+/v7/////////////////////////////////////////////////////gP///////////////8zMzP+ZmZn/TXmP/2fM/v8/Rkv/acz//0t6lf9gtuL/Upu//1ebv/9guuj/TXqQ/2fM/v9BUlz/as7+/0yAnP+EhIT/zMzM//7+/v////////////////////////////////////////////////////+A////////////////zMzM/5mZmf9NeJD/Z8z+/z9GS/9ozP7/S3qV/2C24v9Sm7//V5u//2C65/9MepD/Z8z+/0FSW/9pzf7/TICc/4SEhP/MzMz//v7+/////////////////////////////////////////////////////4D////////////////MzMz/mZmZ/0NFR/9HU1v/QkBB/0dTWv9DRUj/RU5V/0NKTv9ESk//RVBV/0NFSP9HU1r/QkFC/0dTW/9DRkn/hISE/8zMzP/+/v7/////////////////////////////////////////////////////gP///////////////8vMzP+pqKj/e3p6/3t6ev97enr/e3p6/3t6ev97enr/e3p6/3t6ev97enr/e3p6/3t6ev97enr/e3p6/3t6ev+goKD/zMzM//7+/v////////////////////////////////////////////////////+A////////////////1NTU/8zMzP/MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP/Q0ND//////////////////////////////////////////////////////////4D////////////////8/Pz/8/Pz//Pz8//z8/P/8/Pz//Pz8//z8/P/8/Pz//Pz8//z8/P/8/Pz//Pz8//z8/P/8/Pz//Pz8//z8/P/8/Pz//z8/P//////////////////////////////////////////////////////////gP////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA='
from ast import Return
from PIL import ImageTk		# pip install --upgrade Pillow
from base64 import b64decode
import netifaces as ni       # pip install netifaces
import winreg as wr
from pprint import pprint
import os
from os import system, write
import time
from os import strerror
import tkinter
from tkinter import *
from tkinter import ttk
from tkinter import messagebox
from tkinter.scrolledtext import ScrolledText
import platform
import subprocess
import time
import tkinter.scrolledtext as st

# from test import validateAddress

#open CMD, place in file folder and tipe: pyinstaller --onefile ipconfig_v1.14.py 
# pyinstaller --onefile --nowindowed --icon="C:\Users\epugner\Desktop\CURSOS\Practicas Python\practicas propias 2021\config interface - ping tool\img\icon.ico" ipconfig_v1.15.py
# pyinstaller --noconsole --onefile  --icon="C:\Users\epugner\Desktop\CURSOS\Practicas Python\practicas propias 2021\config interface - ping tool\img\icon.ico" ipconfig_v1.15.py
# pyinstaller --noconsole --nowindowed --onefile --icon="C:\Users\epugner\Desktop\CURSOS\Practicas Python\practicas propias 2021\config interface - ping tool\img\icon.ico" ipconfig_v1.15.py
class network_configs():
    def __init__(self,icon_img):
        self.icon_img = icon_img
        self.icon_img = b64decode(self.icon_img)
        self.list_ip_address = []
        self.file_path = os.path.dirname(os.path.abspath(__file__)) + '/config_file_NIC.txt'
        self.file_path2 = os.path.dirname(os.path.abspath(__file__)) + '/ip_address_to_ping.txt'
        # print (self.file_path)
        self.list_devices = []
        self.functon_add_or_edit=""
        self.bgColor = "#E4E4E4"
        self.fontColor ="#000000"
        self.id_label = 0
        self.interface_name_selected_value = ""
        self.interface_name_selected_value_2 = ""

        # Setting root
        self.root = Tk()
        self.root.title('Network Interface Configurator for windows. Created by Jose Pinto. Email: josep8686@gmail.com')
        ancho_ventana = 1340
        alto_ventana = 730
        self.root.maxsize(ancho_ventana, alto_ventana)
        self.root.minsize(ancho_ventana, alto_ventana)
        self.root.resizable(0,0)
        self.root.iconbitmap(os.path.dirname(os.path.abspath(__file__)) + '/img/icon.ico')
        # self.root.wm_attributes("-topmost", True)
        x_ventana = self.root.winfo_screenwidth() // 2 - ancho_ventana // 2
        y_ventana = self.root.winfo_screenheight() // 2 - alto_ventana // 2
        posicion = str(ancho_ventana) + "x" + str(alto_ventana) + "+" + str(x_ventana) + "+" + str(y_ventana)
        self.root.geometry(posicion)
        
        self.validatecommand_ip = self.root.register(self.is_valid_ip)
        self.validatecommand_len_36 = self.root.register(self.is_valid_len_36)
        self.validatecommand_ping = self.root.register(self.is_valid_len_ping) 
        self.validatecommand_ping_count = self.root.register(self.is_valid_len_ping_count) 
        self.validatecommand_ping_time_out = self.root.register(self.is_valid_len_ping_time_out) 

        # Creating a Frame Container
        frame = LabelFrame(self.root, text = 'Options',fg=self.fontColor)
        # frame['bg']=self.bgColor
        frame.grid(row = 0, column = 0, pady = 5, padx=10,sticky='w')
        
        ttk.Button(frame, text = 'Reset all by default', command= self.create_file).grid(row = 0,column=0,sticky= W + E, pady=5, padx=10)
        # ttk.Button(frame, text='Read File',command=self.read_file).grid(row = 0,column=1,sticky= W + E, pady=5, padx=10)

        #Frame ping
        frame2 = LabelFrame(self.root, text = 'Ping Tool',fg=self.fontColor)
        frame2.grid(row = 1, column = 0, pady = 5, padx=10,sticky='w')
        #PING
        Label(frame2, text = 'Address').grid(row = 0, column = 0,sticky='w',padx=120)
        
        Label(frame2, text = 'Attemps').grid(row = 0, column = 1,sticky='w',padx=5,pady=5)
        self.ping_count = Entry(frame2, width=5,validate="key",validatecommand=(self.validatecommand_ping_count, "%d", "%S", "%s"))
        self.ping_count.grid(row = 1, column = 1,pady=0, padx=10, sticky='w')
        self.ping_count.insert(0,'4')
        
        self.ip_field = ttk.Combobox(frame2, width=45,validate="key",validatecommand=(self.validatecommand_ping, "%d", "%S", "%s") ,values=())
        self.ip_field.grid(row = 1, column = 0,padx=10, pady=0, sticky='w')
        # self.ip_field['values'] = ('8.8.8.8',)
        ttk.Button(frame2, text = 'Ping', command= self.ping).grid(row = 1,column=2,sticky='e',pady=10, padx=10)
        ttk.Button(frame2, text = 'Add to list', command= self.add_ping_address).grid(row = 2,column=0,sticky='w',pady=10, padx=40)
        ttk.Button(frame2, text = 'Delete from list', command= self.delete_ping_address).grid(row = 2,column=0,sticky='e',pady=10, padx=40)

        # Result
        frame3 = LabelFrame(self.root, text = 'Result',fg=self.fontColor)
        frame3.grid(row = 0, column = 0, pady = 10, padx=10,sticky='e', rowspan=3)
        # self.text_result = tkinter.Text(frame3,height=16,bg='black', fg = '#00FF00')
        self.text_result = st.ScrolledText(frame3,height=20,width=98,bg='black',fg='#00FF00',)
        self.text_result.bind("<Key>", lambda a: "break")
        

        # self.text_result_var = StringVar()
        # self.text_result = tkinter.Label(frame3,height=16, width=90,textvariable=self.text_result_var, relief=RAISED)
        self.text_result.grid(row = 0, column = 0,pady=10, padx=10, sticky='w')

        # Show ip config
        frame3_1 = LabelFrame(self.root, text = 'Show Interface Config',fg=self.fontColor)
        frame3_1.grid(row = 2, column = 0, pady = 10, padx=10,sticky='w')
        # Label(frame3_1, text = 'Interface Name').grid(row = 0, column = 1,padx=5)
        ttk.Button(frame3_1, text = 'Show', command= self.show_interface_config).grid(row = 0,column=1,sticky='e',pady=10, padx=10)
        interface_name_2 = self.get_connection_name_from_guid()
        # setting variable for Integers
        self.interface_name_variable_2 = StringVar()
        self.interface_name_2 = OptionMenu(
            frame3_1,
            self.interface_name_variable_2,
            *interface_name_2,
            command=self.interface_name_selected_2
        )
        self.interface_name_2.config(width=32)
        self.interface_name_2.grid(row = 0, column = 0,padx=5)

        # Output Message
        self.message = Label(text = '', fg = 'red', background=self.bgColor, font=(7))
        self.message.grid(row = 3, column = 0, columnspan=2, sticky= W + E,pady=0, padx=20)
        

        # frame 4
        frame4 = LabelFrame(self.root, text = 'Interface Configs List',fg=self.fontColor)
        frame4.grid(row = 4, column = 0, pady = 10, padx=10,sticky='e', rowspan=2)

        # buttons config interface
        ttk.Button(frame4, text = 'Add New Config', command= lambda: self.add_config('add')).grid(row = 0,column=0,sticky= W + E,pady=5, padx=10)
        ttk.Button(frame4, text = 'Clone Config', command= lambda: self.clone_config()).grid(row = 0,column=1,sticky= W + E,pady=5, padx=10)
        ttk.Button(frame4, text = 'Edit Config', command= lambda: self.edit_config('edit')).grid(row = 0,column=2,sticky= W + E,pady=5, padx=10)
        ttk.Button(frame4, text = 'Delete Config', command= lambda: self.delete_config()).grid(row = 0,column=3,sticky= W + E,pady=5, padx=10)
        ttk.Button(frame4, text = 'Apply Selected Config On Interface', width=30, command= self.applyConfigOnInterface).grid(row = 0,column=4,pady=5, padx=10,sticky='we')

        #Setting treeview
        self.tree = ttk.Treeview(frame4)
        self.tree['columns']=('x1', 'x2', 'x3', 'x4', 'x5', 'x6', 'x7', 'x8', 'x9','x10')
        self.tree.column('#0',width=0, stretch=NO)
        self.tree.column('#1',anchor=CENTER,width=30,minwidth=30,stretch=NO)
        self.tree.column("#2",anchor=CENTER,width=170,minwidth=170)
        self.tree.column("#3",anchor=CENTER,width=70,minwidth=70)
        self.tree.column("#4",anchor=CENTER,width=100,minwidth=100)
        self.tree.column("#5",anchor=CENTER,width=100,minwidth=100)
        self.tree.column("#6",anchor=CENTER,width=100,minwidth=100)
        self.tree.column("#7",anchor=CENTER,width=100,minwidth=100)
        self.tree.column("#8",anchor=CENTER,width=100,minwidth=100)
        self.tree.column("#9",anchor=CENTER,width=100,minwidth=100)
        self.tree.column("#10",anchor=CENTER,width=400,minwidth=100)
        #---

        self.tree.heading("#0",text='', anchor=CENTER)
        self.tree.heading("#1",text="Id", anchor=CENTER)
        self.tree.heading("#2",text="Interface", anchor=CENTER)
        self.tree.heading("#3",text="Config", anchor=CENTER)
        self.tree.heading("#4",text="IP Address", anchor=CENTER)
        self.tree.heading("#5",text="Mask", anchor=CENTER)
        self.tree.heading("#6",text="IP Gateway", anchor=CENTER)
        self.tree.heading("#7",text="DNS Config", anchor=CENTER)
        self.tree.heading("#8",text="DNS 1", anchor=CENTER)
        self.tree.heading("#9",text="DNS 2", anchor=CENTER)
        self.tree.heading("#10",text="Description", anchor=CENTER)
        #---

        self.tree.grid(row=1,column=0,pady = 10,padx = 20, sticky='w', columnspan=5)
        self.tree.bind('<<TreeviewSelect>>', self.item_selected)
        
        # add a scrollbar
        self.scrollbar = ttk.Scrollbar(frame4, orient=tkinter.VERTICAL, command=self.tree.yview)
        self.tree.configure(yscroll=self.scrollbar.set)
        self.scrollbar.grid(row=1, column=0, sticky='nes',pady = 10,padx = 3,columnspan=5)

        self.icon_img = ImageTk.PhotoImage(data=self.icon_img)
        self.root.tk.call('wm', 'iconphoto', self.root._w, self.icon_img)

        self.read_file()
        self.read_file2()
        self.root.mainloop()

    def add_ping_address(self):
        # new_val = (self.ip_field.get(),)
        new_val = self.ip_field.get()
        if new_val not in self.ip_field['values'] and new_val != '':
            file = open(self.file_path2, 'a',encoding="utf-8")
            file.write(new_val+'\n')
            # print(new_val)
            file.close()
            self.read_file2()
                
    def delete_ping_address(self):
        try:
            new_val = self.ip_field.get()
            lines = []
            with open (self.file_path2,'rb') as f2:
                for line in f2:
                    encoding = 'utf-8'
                    valueLine = (str(line,encoding).rstrip('\r\n'))
                    lines.append(valueLine)
            f2.close
            
            lines.remove(new_val)
            
            new_file = open(self.file_path2, "w+",encoding="utf-8")
            for line in lines:
                new_file.write(line + "\n")
            new_file.close()
            self.read_file2()
        except:
            pass

    def get_connection_name_from_guid(self):
        iface_guids = ni.interfaces()
        iface_names = ['(unknown)' for i in range(len(iface_guids))]
        reg = wr.ConnectRegistry(None, wr.HKEY_LOCAL_MACHINE)
        reg_key = wr.OpenKey(reg, r'SYSTEM\CurrentControlSet\Control\Network\{4d36e972-e325-11ce-bfc1-08002be10318}')
        for i in range(len(iface_guids)):
            try:
                reg_subkey = wr.OpenKey(reg_key, iface_guids[i] + r'\Connection')
                iface_names[i] = wr.QueryValueEx(reg_subkey, 'Name')[0]
            except FileNotFoundError:
                pass
        return iface_names

    def show_interface_config(self):
        self.message['text'] = ''
        self.text_result.delete("1.0","end")
        command_string = 'netsh interface ipv4 show dns ' + self.interface_name_selected_value_2
        command_result = self.subprocessPopen(command_string)
        self.text_result.insert(1.0,command_result)        
        command_string = 'netsh interface ipv4 show address ' + self.interface_name_selected_value_2
        command_result = self.subprocessPopen(command_string)
        self.text_result.insert(1.0,command_result)

    def ping(self):
        self.text_result.delete("1.0","end")
        self.message['text'] = 'Wait a few seconds'
        self.root.update()
        # timeout_var=60
        ipAddr = self.ip_field.get()
        pingCount = self.ping_count.get()

        if platform.system().lower() == 'windows':
            numFlag = '-n'
        else:
            numFlag = '-c'
        completedPing = subprocess.Popen(args=['ping', numFlag, pingCount, '-w', '1', ipAddr],text=True,
                                        stdout=subprocess.PIPE,    # Capture standard out
                                        stderr=subprocess.STDOUT, # Capture standard error
                                        stdin=subprocess.DEVNULL,
                                        creationflags = 0x08000000,
                                        # timeout=timeout_var, # time out process
                                        universal_newlines=True,
                                        encoding="cp850").communicate()[0]
        ping_result = completedPing
        print (ping_result)
        self.text_result.insert(1.0,ping_result)
        self.message['text'] = ''

    def interface_name_selected(self,choice):
        self.interface_name_selected_value = choice

    def interface_name_selected_2(self,choice):
        self.interface_name_selected_value_2 = choice

    def interface_config_selected(self,choice1,choice2=''):
        self.interface_config_selected_value = choice1
        if choice1 == 'dhcp':
            self.interface_ip.delete(0,'end')
            self.interface_mask.delete(0,'end')
            self.interface_gateway.delete(0,'end')
            self.interface_ip.config(state='disabled')
            self.interface_mask.config(state='disabled')
            self.interface_gateway.config(state='disabled')
            self.dns_config.config(state='normal')
            self.dns_config_variable.set(self.configs_dns[0])
            self.dns_config_selected_value = self.configs_dns[0]
            if choice2 == 'dhcp':
                self.dns_config.config(state='normal')
                self.dns_config_variable.set(self.configs_dns[0])
                self.dns_config_selected_value = self.configs_dns[0]
                self.dns_1.delete(0,'end')
                self.dns_2.delete(0,'end')
                self.dns_1.config(state='disabled')
                self.dns_2.config(state='disabled')

            elif choice2 == 'static':
                self.dns_config.config(state='normal')
                self.dns_config_variable.set(self.configs_dns[1])
                self.dns_config_selected_value = self.configs_dns[1]
                self.dns_config_selected_value = 'static'
                self.dns_1.config(state='normal')
                self.dns_2.config(state='normal')
        elif choice1 == 'static':
            self.interface_ip.config(state = 'normal')
            self.interface_mask.config(state='normal')
            self.interface_gateway.config(state='normal')
            self.dns_config.config(state='disabled')
            self.dns_config_variable.set(self.configs_dns[1])
            self.dns_config_selected_value = 'static'
            self.dns_1.config(state='normal')
            self.dns_2.config(state='normal')

    def dns_config_selected(self,choice):
        self.dns_config_selected_value = choice
        if choice == 'dhcp':    
            self.dns_config_variable.set(self.configs_dns[0])
            self.dns_1.config(state='disabled')
            self.dns_2.config(state='disabled')
        elif choice == 'static':
            self.dns_config_variable.set(self.configs_dns[1])
            self.dns_1.config(state='normal')
            self.dns_2.config(state='normal')

    def is_valid_ip(self,action, char, text): #VALIDATE IP ADDRESS
        # chekin for character
        # if action != "1":
        #     return True
        # return char in "0123456789." and text.count('.') < 4 and len(text) < 15
        # print('action', action)
        # chekin for character
        if action != "1":
            return True
        # print('get' , self.interface_ip.get())
        # print('text[-1:]: ', text[-1:])
        # print('-char: ', char , ' -text:', text, ' -text.count("."): ', text.count('.'), ' -len(text: ', len(text))
        # print (text.split('.'))
        
        # resultToReturn = char in "0123456789." and text.count('.') < 4 and char != '.' and len(text) < 15
        if char in "0123456789." and len(text) < 15:
            if text.count('.') < 3:
                return True
            elif text.count('.') == 3 and char != '.':
                return True
            else:
                return False
        return False
            

        # print ('resultToReturn: ', resultToReturn)
        # return resultToReturn
    
    def is_valid_len_36(self,action, char, text): #VALIDATE LEN ENTRY
        #chekin for character
        if action != "1":
            return True
        return len(text) < 36
    
    def is_valid_len_ping(self,action, char, text): #VALIDATE IP ADDRESS
        #chekin for character
        if action != "1":
            return True
        return len(text) < 50
    
    def is_valid_len_ping_count(self,action, char, text): #VALIDATE IP ADDRESS
        #chekin for character
        if action != "1":
            return True
        return char in "0123456789" and len(text) < 2
    
    def is_valid_len_ping_time_out(self,action, char, text): #VALIDATE IP ADDRESS
        #chekin for character
        if action != "1":
            return True
        return char in "0123456789" and len(text) < 4

    def load_form_addEdit(self,option_choice_btn):
        #Creating window toplevel
        self.edit_wind = Toplevel()
        ancho_ventana = 870
        alto_ventana = 160
        self.edit_wind.maxsize(ancho_ventana, alto_ventana)
        self.edit_wind.minsize(ancho_ventana, alto_ventana)
        self.edit_wind.title = 'Edit config'
        self.edit_wind.resizable(0,0)
        # self.root.wm_attributes("-topmost", True)
        x_ventana = self.root.winfo_screenwidth() // 2 - ancho_ventana // 2
        y_ventana = self.root.winfo_screenheight() // 2 - alto_ventana // 2
        posicion = str(ancho_ventana) + "x" + str(alto_ventana) + "+" + str(x_ventana) + "+" + str(y_ventana)
        self.edit_wind.geometry(posicion)
        
        # 0-LINE
        Label(self.edit_wind, text = 'LINE').grid(row = 0, column = 0,sticky='w',padx=25)
        Entry(self.edit_wind, textvariable = StringVar(self.edit_wind, value = self.device[10]), state = 'readonly', width=4).grid(row = 1, column = 0, sticky='w',padx=25)
        
        # 1-ID
        Label(self.edit_wind, text = 'ID').grid(row = 0, column = 0,sticky='e',padx=30)
        Entry(self.edit_wind, textvariable = StringVar(self.edit_wind, value = self.device[0]), state = 'readonly', width=4).grid(row = 1, column = 0, sticky='e',padx=25)

        # 2-INTERFACE NAME
        Label(self.edit_wind, text = 'Interface Name').grid(row = 0, column = 1,padx=5)
        interface_name = self.get_connection_name_from_guid()
        # setting variable for Integers
        self.interface_name_variable = StringVar()
        count = 0
        for names in interface_name:
            count+= 1
            if self.device[1] == names:
                self.interface_name_variable.set(interface_name[count-1])
                # break
        self.interface_name = OptionMenu(
            self.edit_wind,
            self.interface_name_variable,
            *interface_name,
            command=self.interface_name_selected
        )
        self.interface_name.config(width=32)
        self.interface_name.grid(row = 1, column = 1,padx=5)

        # 3-INTERFACE_CONFIG
        Label(self.edit_wind, text = 'IP Config dhcp/static').grid(row = 0, column = 2,padx=5)
        self.configs = ['dhcp','static']
        # setting variable for Integers
        self.ip_config_variable = StringVar()
        if self.device[2] == '':
            self.ip_config_variable.set(self.configs[0]) # Select option default to show
        elif self.device[2] == self.configs[0]:
            self.ip_config_variable.set(self.configs[0])
        elif self.device[2] == self.configs[1]:
            self.ip_config_variable.set(self.configs[1])
        else:
            self.ip_config_variable.set(self.configs[0])
        # creating widget
        self.interface_config = OptionMenu(
            self.edit_wind,
            self.ip_config_variable,
            *self.configs,
            command=self.interface_config_selected
        )
        self.interface_config.config(width=5)
        self.interface_config.grid(row = 1, column = 2,padx=5)

        # 4-IP
        Label(self.edit_wind, text = 'IP Address *').grid(row = 0, column = 3,padx=5)
        self.interface_ip= Entry(self.edit_wind,width=16,validate="key",validatecommand=(self.validatecommand_ip, "%d", "%S", "%s"))
        self.interface_ip.grid(row = 1, column = 3,padx=5)
        for letter in reversed(self.device[3]):
            self.interface_ip.insert(0,letter)

        # 5-MASK
        Label(self.edit_wind, text = 'Mask Address *').grid(row = 0, column = 4,padx=5)
        self.interface_mask= Entry(self.edit_wind,width=16,validate="key",validatecommand=(self.validatecommand_ip, "%d", "%S", "%s"))
        self.interface_mask.grid(row = 1, column = 4,padx=5)
        for letter in reversed(self.device[4]):
            self.interface_mask.insert(0,letter)


        # 6-IP Gateway
        Label(self.edit_wind, text = 'IP Gateway').grid(row = 0, column = 5,padx=5)
        self.interface_gateway= Entry(self.edit_wind,width=16,validate="key",validatecommand=(self.validatecommand_ip, "%d", "%S", "%s"))
        self.interface_gateway.grid(row = 1, column = 5,padx=5)
        for letter in reversed(self.device[5]):
            self.interface_gateway.insert(0,letter)


        # 7-DNS_CONFIG
        Label(self.edit_wind, text = 'DNS Config dhcp/static *').grid(row = 2, column = 0,padx=5)
        self.configs_dns = ['dhcp','static']
        # setting variable for Integers
        self.dns_config_variable = StringVar()
        if self.device[6] == '':
            self.dns_config_variable.set(self.configs_dns[0]) # Select option default to show
        elif self.device[6] == self.configs_dns[0]:
            self.dns_config_variable.set(self.configs_dns[0])
        elif self.device[6] == self.configs_dns[1]:
            self.dns_config_variable.set(self.configs_dns[1])
        else:
            self.dns_config_variable.set(self.configs_dns[0])
        # creating widget
        self.dns_config = OptionMenu(
            self.edit_wind,
            self.dns_config_variable,
            *self.configs_dns,
            command= self.dns_config_selected
        )
        self.dns_config.config(width=5)
        self.dns_config.grid(row = 3, column = 0,padx=5)

        # 8-DNS 1
        Label(self.edit_wind, text = 'DNS 1').grid(row = 2, column = 1,padx=40,sticky='w')
        self.dns_1= Entry(self.edit_wind,width=16,validate="key",validatecommand=(self.validatecommand_ip, "%d", "%S", "%s"))
        self.dns_1.grid(row = 3, column = 1,padx=15,sticky='w')
        # self.dns_1.insert(0,self.device[7])
        for letter in reversed(self.device[7]):
            self.dns_1.insert(0,letter)

        # 9-DNS 2
        Label(self.edit_wind, text = 'DNS 2').grid(row = 2, column = 1,padx=40,sticky='e')
        self.dns_2= Entry(self.edit_wind,width=16,validate="key",validatecommand=(self.validatecommand_ip, "%d", "%S", "%s"))
        self.dns_2.grid(row = 3, column = 1,padx=15,sticky='e')
        # self.dns_2.insert(0,self.device[8])
        for letter in reversed(self.device[8]):
            self.dns_2.insert(0,letter)

        # 10-OBSERVATION
        Label(self.edit_wind, text = 'Description').grid(row = 2, column = 2, columnspan=5,padx=5)
        self.observation= Entry(self.edit_wind, width=67,validate="key",validatecommand=(self.validatecommand_len_36, "%d", "%S", "%s"))
        self.observation.grid(row = 3, column = 2,columnspan=5,padx=5)
        # Button(self.edit_wind, text = 'Update', command = lambda: self.edit_line(name, new_name.get(), new_price.get())).grid(row = 4, column = 2, sticky=W)
        self.observation.insert(0,self.device[9])
        
        #BUTTONS
        ttk.Button(self.edit_wind, text = 'Save', command= lambda: self.save_registry(option_choice_btn)).grid(row = 5,column=0, columnspan=6,sticky= W,pady=15, padx=300)
        ttk.Button(self.edit_wind, text = 'Cancel', command= lambda: self.edit_wind.destroy()  ).grid(row = 5,column=0, columnspan=6 ,sticky= E,pady=15, padx=300)
        
        if option_choice_btn == 'edit':
            #SETTING OPTION-MENU
            self.interface_name_selected(self.device[1])
            self.interface_config_selected(self.device[2],self.device[6])
            self.dns_config_selected(self.device[6])
        elif option_choice_btn == 'add':
            #SETTING OPTION-MENU
            self.interface_name_selected_value = ""
            self.interface_config_selected_value = "dhcp"
            self.dns_config_selected_value = "dhcp"
        
        # icon_img = b64decode(icon_img)
        # self.icon_img = ImageTk.PhotoImage(data=icon_img)
        self.edit_wind.tk.call('wm', 'iconphoto', self.edit_wind._w, self.icon_img)
        self.edit_wind.grab_set() # Mantiene el foco de la ventana hasta que se cierre y devuelve la interacción con la ventana principal el root en este caso.
        self.edit_wind.focus_set() # Mantiene el foco cuando se abre la ventana.

    def edit_config(self,option_choice_btn):
        # print(option_choice_btn)
        self.message['text'] = ''
        try:
            self.tree.item(self.tree.selection())['text'][0]
        except IndexError as e:
            self.message['text'] = 'Please Select a Record'
            return
        self.message['text']=''
        self.device=self.deviceSelected()
        if option_choice_btn == 'clone':
            pass
        else:
            self.load_form_addEdit(option_choice_btn)

    def delete_config(self):
        # print(option_choice_btn)

        self.message['text'] = ''
        try:
            self.tree.item(self.tree.selection())['text'][0]
        except IndexError as e:
            self.message['text'] = 'Please Select a Record'
            return
        self.message['text']=''
        self.device=self.deviceSelected()
        
        MsgBox = tkinter.messagebox.askquestion ('Delete a config record','Are you sure you want to delete the selected config:' + self.device[0],icon = 'warning')
        if MsgBox == 'yes':
            a_file = open(self.file_path, "r",encoding="utf-8")
            lines = a_file.readlines()
            a_file.close()
            del lines[int(self.device[10])]
            new_file = open(self.file_path, "w+",encoding="utf-8")
            for line in lines:
                new_file.write(line)
            new_file.close()
            self.read_file()
            self.message['text'] = 'Config Deleted'

    def add_config(self,option_choice_btn):
        # print(option_choice_btn)
        self.message['text'] = ''
        self.device = [''] * 11
        # print(self.device)
        self.load_form_addEdit(option_choice_btn)

        # Setting defult entry
        self.interface_ip.config(state='disabled')
        self.interface_mask.config(state='disabled')
        self.interface_gateway.config(state='disabled')
        self.dns_1.config(state='disabled')
        self.dns_2.config(state='disabled')

    def validateAddress(self, value):
        print ("value ",value)
        if value != "":
            separador = "."
            separadorCount = value.count(separador)
            listValue = value.split(separador)
            countSub = 0
            print ("listValue", listValue)
            print ("separadorCount", separadorCount)
            
            for i in listValue:
                # if type(i) is int:
                if i.isdigit():
                    if int(i) <= 255 and int(i) >= 0:
                        print (i)
                        countSub = countSub + 1
                else:
                    return False
            
            # print (len(valorSeparado))
            print ("countSub" , countSub)
            
            
            if countSub == 4 and separadorCount == 3:
                return True
            else:
                return False
        else:
            return False
        
    def validateAddressOptional(self, value):
        print ("value ",value)
        if value == "":
            return True
        else:
            separador = "."
            separadorCount = value.count(separador)
            listValue = value.split(separador)
            countSub = 0
            print ("listValue", listValue)
            print ("separadorCount", separadorCount)
            
            for i in listValue:
                # if type(i) is int:
                if i.isdigit():
                    if int(i) <= 255 and int(i) >= 0:
                        print (i)
                        countSub = countSub + 1
                else:
                    return False
            
            # print (len(valorSeparado))
            print ("countSub" , countSub)
            
            
            if countSub == 4 and separadorCount == 3:
                return True
            else:
                return False

    def save_registry(self,option_choice_btn):
        # print ('Puntos: ',self.interface_ip.get().count('.'))
        # c = '.'
        # s = self.interface_ip.get()
        # posiciones = [pos for pos, char in enumerate(s) if char == c]
        # print('posiciones: ', posiciones)
        # if len(posiciones)<4:
        #     for index in posiciones:
        #         if self.interface_ip.get()[index-1].isdigit() and self.interface_ip.get()[index+1].isdigit() and len(posiciones)<4:
        #             pass
        #         else:
        #             tkinter.messagebox.showerror(title=None, message=None)
        # else:
        #     tkinter.messagebox.showerror(title=None, message=None)
        
        # print ("campo a evaluar" , self.interface_ip.get() , "tipo: " , type(self.interface_ip.get()))
        
        if self.interface_config_selected_value == "static":
            if (self.validateAddress(self.interface_ip.get()) and self.validateAddress(self.interface_mask.get()) and self.validateAddressOptional(self.interface_gateway.get()) and self.interface_name_selected_value != ""):
                pass
            else:
                print ("Error en condifguracion ip insertada")
                return
        
        if self.interface_config_selected_value == "dhcp":
            if self.interface_name_selected_value == "":
                print ("Seleccione nombre de interfaz")
                return

        if self.validateAddressOptional(self.dns_1.get()) and self.validateAddressOptional(self.dns_2.get()):
            pass
        else:
            print ("Error en los DNS")
            return

        # print('device >', self.device)
        line_text = self.interface_name_selected_value +';'+ self.interface_config_selected_value +';'+ self.interface_ip.get() +';'+ self.interface_mask.get() +';'+ self.interface_gateway.get() +';'+ self.dns_config_selected_value +';'+ self.dns_1.get() +';'+ self.dns_2.get() +';'+ self.observation.get()
        # print('line_text >', line_text)
        if option_choice_btn == 'add':
            file = open(self.file_path, 'a',encoding="utf-8")
            file.write(line_text+'\n')
            # print(line_text)
            file.close()
            self.read_file()

        if option_choice_btn == 'edit':            
            file = open(self.file_path,'r+' ,encoding="utf-8")
            list_text_file = file.readlines()
            list_text_file[int(self.device[10])]=str(line_text)+'\n'
            file.seek(0) #este comando ubica el cursor en el caracter indicado en el argumento
            file.writelines(list_text_file)
            file.close()
            self.read_file()
        self.edit_wind.destroy()



    def clone_config(self):
        self.message['text'] = ''
        try:
            self.tree.item(self.tree.selection())['text'][0]
        except IndexError as e:
            self.message['text'] = 'Please Select a Record'
            return
        
        self.device=self.deviceSelected()
        line_text = ";".join(self.device[1:10])

        file = open(self.file_path, 'a',encoding="utf-8")
        print('file', file)
        file.write(line_text+'\n')
        # print(line_text)
        file.close()
        self.read_file()
        self.message['text'] = 'Config cloned successfully  '

    def item_selected(self,event):
        # bind the select event    
        device=self.deviceSelected()
        if device:
            self.message['text'] = 'Config Selected: ' + str(device)

    def applyConfigOnInterface(self):
        try:
            device=self.deviceSelected()
            if device:
                self.message['text'] = 'Appling new settings...'
                self.root.update()
                interface_name = device[1]
                interface_config = device[2]
                ip_interface = device[3]
                mask_interface = device[4]
                gateway_interface = device[5]
                dns_config = device[6]
                ip_dns_1 = device[7]
                ip_dns_2 = device[8]
                # netsh interface ipv4 set dns name="Ethernet" static 8.8.8.8
                # netsh interface ipv4 set dns name="Ethernet" static 8.8.4.4 index=2
                if interface_config == 'static':
                    command_string = 'netsh interface ipv4 set address name="' + interface_name + '" ' + interface_config + ' ' + ip_interface + ' ' + mask_interface + ' ' + gateway_interface
                    command_result = self.subprocessPopen(command_string)
                elif interface_config == 'dhcp':
                    command_string = 'netsh interface ipv4 set address name="' + interface_name + '" ' + interface_config
                    command_result = self.subprocessPopen(command_string)
                    # system(command_string)
                if dns_config == 'dhcp':
                    command_string = 'netsh interface ipv4 set dnsservers name="' + interface_name + '" source=dhcp'
                    command_result = self.subprocessPopen(command_string)
                    # system(command_string)
                elif dns_config=='static':
                    if ip_dns_1 != '':
                        #netsh interface ipv4 set dnsservers name="Ethernet" static 10.0.11.1 primary
                        command_string = 'netsh interface ipv4 set dnsservers name="' + interface_name + '" static ' + ip_dns_1 + ' primary'
                        command_result = self.subprocessPopen(command_string)
                        # system(command_string)
                    if ip_dns_2 != '':
                        #netsh interface ipv4 add dnsservers name="Ethernet" 10.0.22.2 index=2
                        command_string = 'netsh interface ipv4 add dnsservers name="' + interface_name + '" ' + ip_dns_2 + ' index=2'
                        # print ('command string dns 2: ' + command_string + '-') 
                        command_result = self.subprocessPopen(command_string)
                        # system(command_string)

                self.message['text'] = 'Appling new settings...'
                self.root.update()
                self.message['text'] = 'Configuration Done.'
                self.root.update()
                print (command_string)
                print (command_result)
                self.text_result.delete("1.0","end")
                self.message['text'] = 'Wait a few seconds'
                self.root.update()
                self.text_result.insert(1.0,command_result)
                self.text_result.insert(1.0,command_string)
                
                self.message['text'] = ''
                
                
                
                
                
                
                
        except:
            self.message['text'] = 'Unknow Error.'

    def create_file(self):
        
        # \n is placed to indicate EOL (End of Line)
        L1 = ["#Comments\n",
        "#This file is a simple text with config parameters for appling settings on networks interface.\n",
        "#gateway_IP, DNS_1, and DNS_2 are optional. When trying setting dhcp for Intarface_IP and DNS_1 or DNS_2 are filled DNS gets as static.\n",
        "#The next line shows the format splitted with ;\n",
        "#Interface_name; type_config:static or dhcp; interface_IP; mask;gateway_IP; dhcp/static; DNS_1; DNS_2; Description_Optional\n",
        "#Ethernet;static;192.168.10.250;255.255.255.0;192.168.10.2;static;192.168.10.2;8.8.8.8;Config x\n",
        "Ethernet;static;192.168.1.250;255.255.255.0;192.168.1.1;static;8.8.8.8;8.8.4.4;Config 1\n",
        "Ethernet;static;10.5.1.100;255.0.0.0;;static;8.8.8.8;;Config 2\n",
        "Ethernet;static;10.5.1.100;255.0.0.0;10.5.1.1;static;;;Config 3\n",
        "Ethernet;dhcp;;;;static;8.8.8.8;8.8.4.4;Config 4 ip dhcp, dns static\n",
        "Ethernet;dhcp;;;;dhcp;;;Config 5 dhcp\n",
        "Wi-Fi;dhcp;;;;dhcp;;;Config 6 dhcp\n",
        "Wi-Fi;dhcp;;;;static;8.8.8.8;8.8.4.4;Config 7 ip dhcp, dns static\n",
        "Wi-Fi;static;192.168.10.250;255.255.255.0;192.168.10.2;static;192.168.10.2;8.8.8.8;Config 8\n"]      
        
        L2 = ["8.8.8.8\n","www.google.com\n"]
        
        MsgBox = tkinter.messagebox.askquestion ('Reset all by default','Are you sure you want to reset to factory default?',icon = 'warning')
        if MsgBox == 'yes':
            try:
                file1=open(self.file_path,"w") #lectura y escritura
                file1.writelines(L1)
                file1.close()
                file2=open(self.file_path2,"w") #lectura y escritura
                file2.writelines(L2)
                file2.close()
                self.message['text'] = "Reset was successfully done"
                self.root.update()
                self.read_file()
                self.read_file2()
            except:
                self.message['text'] = "Sorry. Something went wrong"
                self.root.update()

    def read_file(self):
        #SE LEE ARCHIVO DE DATOS CON INFORMACIÓN DE LOS DISPOSITIVOS DE RED
        try:
            count = 1
            id_textLine = 0
            self.list_devices = []
            with open (self.file_path,'rb') as f:
                for line in f:
                    encoding = 'utf-8'
                    valueLine = (str(line,encoding).rstrip('\r\n').split(';'))
                    if len(valueLine) == 9:
                        if '#' not in valueLine[0] and len(line) != 0:
                            self.id_label+=1
                            self.list_devices.append(valueLine)
                            self.list_devices[count-1].insert(0,str(count))
                            self.list_devices[count-1].insert(len(self.list_devices[0]),str(id_textLine))
                            count+=1                            
                        else:
                            pass
                    id_textLine += 1
            f.close
            self.load_config()
        except IOError as e:
            # print("Se produjo un error de E/S: ", strerror(e.errno))
            self.message['text'] = "Error I/O: ", strerror(e.errno), 'path_file=' + '{'+self.file_path+'}'
            self.root.update()

    def read_file2(self):
        try:
            self.list_ip_address = []
            with open (self.file_path2,'rb') as f2:
                for line in f2:
                    encoding = 'utf-8'
                    valueLine = (str(line,encoding).rstrip('\r\n'))
                    self.list_ip_address.append(valueLine)
            f2.close
            # print(self.list_ip_address)
            self.ip_field['values']=self.list_ip_address

        except IOError as e:
            self.message['text'] = "Error I/O: ", strerror(e.errno), 'path_file=' + '{'+self.file_path2+'}'
            self.root.update() 
            
    def load_config(self):
        try:
            # Cleaning table
            records = self.tree.get_children()
            for element in records:
                self.tree.delete(element)
            self.message['text'] = "Loading file... Pathfile: " + self.file_path
            self.root.update()
            time.sleep(0.5)
            #Load lines into tree

            for device in reversed(self.list_devices):
                if len(device) == 11:
                    # self.tree.insert('',0,text=device[0], values =(device[0],device[1],device[2],device[3],device[4],device[5],device[6],device[7],device[8],device[9]))
                    self.tree.insert('',0,text=device[0], values =(device[0],device[1],device[2],device[3],device[4],device[5],device[6],device[7],device[8],device[9]))
                    self.root.update()

        except:
            self.message['text'] = "File format error."
            self.root.update()
            return

        self.message['text'] = "File loaded successfully. Pathfile: " + self.file_path
        self.root.update()

    def deviceSelected(self):
        # print (self.list_devices)
        self.message['text'] = 'Conecting to device. Wait a few seconds'
        try:
            # self.tree.item(self.tree.selection())['text'][0]
            self.tree.item(self.tree.selection())['text']
        except IndexError as e:
            self.message['text'] = 'Please Select a Device'
            return
        self.message['text']='x'
        # name = self.tree.item(self.tree.selection())['text'][0]
        name = self.tree.item(self.tree.selection())['text']
        # print (name)
        for device in self.list_devices:
            # print ('name ' , name, ' device ', device[0])
            if name in device[0]:
                return (device)
    def subprocessPopen(self,command_string):
        process_result = subprocess.Popen(command_string,text=True,
                                    stdout=subprocess.PIPE,    # Capture standard out
                                    stderr=subprocess.STDOUT,
                                    stdin=subprocess.DEVNULL,
                                    creationflags = 0x08000000,
                                    universal_newlines=True,
                                    encoding="cp850").communicate()[0]
        return process_result
    
if __name__ == '__main__':
    app = network_configs(icon_img)